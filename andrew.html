<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>Andrew's PT Report Summarizer v1.3</title>
    <meta name="author" content="Jason Wall" />

    <style>
      table,
      th,
      td {
        border: 1px solid black;
      }
    </style>
  </head>

  <body>
    <p>
        Data should be in the form of a tab or comma delimited lines with four fields:<br />
        Date, Name, Type, Status
    </p>
    <textarea id="csv" style="width: 100%; height: 350px"></textarea>
    <input type="button" id="summarize" value="Summarize" onclick="summarize()" />
    <br />
    <h2>Summary</h2>
    <div id="result"></div>

    <h2>Used Data</h2>
    <div id="data"></div>
    <h2>Ignored Data</h2>
    <div id="ignoreddata"></div>
    <script>
      const nameWhitelist = new Map([
        // require special handling below.
        ['COTA Visit', 0],
        ['PTA Visit', 0],
        ['LPN/LVN - Skilled Nursing Visit', 0],

        // are just counted.
        ['HHA Visit', 0],

        ['MSW Evaluation', 0],
        ['MSW Visit', 0],

        ['OASIS-E Discharge', 0],
        ['OASIS-E Discharge (OT)', 0],
        ['OASIS-E Discharge (PT)', 0],
        ['OASIS-E Discharge (ST)', 0],
        ['OASIS-E Recertification', 0],
        ['OASIS-E Recertification (OT)', 0],
        ['OASIS-E Recertification (PT)', 0],
        ['OASIS-E Recertification (ST)', 0],
        ['OASIS-E Resumption of Care', 0],
        ['OASIS-E Resumption of Care (PT)', 0],
        ['OASIS-E Start of Care', 0],
        ['OASIS-E Start of Care (PT)', 0],

        ['OT Visit', 0],
        ['OT Discharge Eval w/ Discharge Summary', 0],
        ['OT Evaluation', 0],
        ['OT Re-Evaluation', 0],
        ['OT Re-Evaluation w/Supervisory Visit', 0],

        ['PT Discharge w/Discharge Summary', 0],
        ['PT Evaluation', 0],
        ['PT Re-Evaluation', 0],
        ['PT Re-evaluation w/Supervisory Visit ', 0],
        ['PT Visit', 0],

        ['RN - Skilled Nursing Visit', 0],

        ['Skilled Nurse Visit', 0],

        ['SN Evaluation', 0],
        ['SN Foley Change', 0],

        ['SNV W/ Discharge Summary', 0],
        ['SNV w/ LPN Supervision', 0],

        ['ST Discharge', 0],
        ['ST Evaluation', 0],
        ['ST Re-Evaluation', 0],
        ['ST Visit', 0],
      ]);

      const statusRemove = new Map([['Missed Visit (Approved) (MV)', 0]]);
      const groupBy = function (xs, key) {
        return xs.reduce(function (rv, x) {
          if (!rv.has(x[key])) {
            rv.set(x[key], []);
          }
          rv.get(x[key]).push(x);

          return rv;
        }, new Map());
      };

      document.getElementById('ignoreddata').innerHTML = '';
      const summarize = function () {
        let summary = new Map();
        let data = [];

        let csv = document.getElementById('csv');
        let lines = csv.value.split('\n');

        // read in the csv data.
        for (let line of lines) {
          // ignore lines that are empty or have 'Task Type' in the line somewhere
          if (line == undefined || line.trim().length === 0 || line.indexOf('Task Type') > -1) {
            continue;
          }

          const fields = line.split(/\t|,/);
          const item = {
            date: fields[0],
            name: fields[1],
            type: fields[2],
            status: fields[3],
          };

          // only accept lines that are in the Whitelist.
          if (!nameWhitelist.has(item.name) || statusRemove.has(item.status)) {
            document.getElementById('ignoreddata').innerHTML += line + '<br />';
            continue;
          }

          data.push(item);
        }

        let dataHtml = '<table><tr><td>Date</td><td>Name</td><td>Type</td><td>Status</td></tr>';
        for (const item of data) {
          dataHtml += `<tr><td>${item.date}</td><td>${item.name}</td><td>${item.type}</td><td>${item.status}</td></tr>`;
        }
        dataHtml += '</table>';
        document.getElementById('data').innerHTML = dataHtml;

        const groups = groupBy(data, 'type');

        for (let key of groups.keys()) {
          console.log(key);
        }

        document.getElementById('result').innerHTML = '';
        groups.forEach(function (value, key) {
          if (key == 'OT') {
            const cota = value.filter((o) => o.name == 'COTA Visit').length;
            document.getElementById('result').innerHTML += `${key}: ${value.length - cota}<br />`;
            document.getElementById('result').innerHTML += `COTA: ${cota}<br />`;
            return;
          }

          if (key == 'PT') {
            const pta = value.filter((o) => o.name == 'PTA Visit').length;
            document.getElementById('result').innerHTML += `${key}: ${value.length - pta}<br />`;
            document.getElementById('result').innerHTML += `PTA: ${pta}<br />`;
            return;
          }

          if (key == 'SN') {
            const lpn = value.filter((o) => o.name == 'LPN/LVN - Skilled Nursing Visit').length;
            document.getElementById('result').innerHTML += `${key}: ${value.length - lpn}<br />`;
            document.getElementById('result').innerHTML += `LPN: ${lpn}<br />`;
            return;
          }

          document.getElementById('result').innerHTML += `${key}: ${value.length}<br />`;
        });
      };
    </script>
  </body>
</html>
